<!DOCTYPE html>
<html>
<head>
    <title>Voice Server Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        #output {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Voice Server Diagnostic Tool</h1>

    <div class="test-section">
        <h2>Test 1: Server Status</h2>
        <button onclick="testServerStatus()">Check if server is running</button>
    </div>

    <div class="test-section">
        <h2>Test 2: Health Check</h2>
        <button onclick="testHealthCheck()">Test /health endpoint</button>
    </div>

    <div class="test-section">
        <h2>Test 3: List Voices</h2>
        <button onclick="testListVoices()">Test /voices endpoint</button>
    </div>

    <div class="test-section">
        <h2>Test 4: Generate Audio (Direct)</h2>
        <input type="text" id="testText" placeholder="Enter text to generate" value="Hello, this is a test." style="width: 300px;">
        <input type="text" id="testSpeaker" placeholder="Speaker name" value="John F. Kennedy" style="width: 200px;">
        <button onclick="testGenerateDirect()">Generate via voice server directly</button>
    </div>

    <div class="test-section">
        <h2>Test 5: Generate Audio (via Next.js API)</h2>
        <button onclick="testGenerateViaAPI()">Generate via /api/voice/generate</button>
    </div>

    <div id="output"></div>

    <script>
        const VOICE_SERVER = 'http://localhost:8000';
        const NEXTJS_API = 'http://localhost:3000';

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('output').innerHTML = '';
        }

        async function testServerStatus() {
            clearLog();
            log('Testing server status...', 'info');

            try {
                const response = await fetch(VOICE_SERVER);
                const data = await response.json();
                log('âœ… Server is running!', 'success');
                log(JSON.stringify(data, null, 2), 'success');
            } catch (error) {
                log('âŒ Server is NOT running!', 'error');
                log('Error: ' + error.message, 'error');
                log('Make sure to start: python voice_clone_server.py', 'error');
            }
        }

        async function testHealthCheck() {
            clearLog();
            log('Testing health endpoint...', 'info');

            try {
                const response = await fetch(`${VOICE_SERVER}/health`);
                const data = await response.json();
                log('âœ… Health check passed!', 'success');
                log(JSON.stringify(data, null, 2), 'success');
            } catch (error) {
                log('âŒ Health check failed!', 'error');
                log('Error: ' + error.message, 'error');
            }
        }

        async function testListVoices() {
            clearLog();
            log('Testing voices endpoint...', 'info');

            try {
                const response = await fetch(`${VOICE_SERVER}/voices`);
                const data = await response.json();
                log('âœ… Voices endpoint working!', 'success');
                log(JSON.stringify(data, null, 2), 'success');
            } catch (error) {
                log('âŒ Voices endpoint failed!', 'error');
                log('Error: ' + error.message, 'error');
            }
        }

        async function testGenerateDirect() {
            clearLog();
            const text = document.getElementById('testText').value;
            const speaker = document.getElementById('testSpeaker').value;

            log(`Testing direct generation...`, 'info');
            log(`Text: "${text}"`, 'info');
            log(`Speaker: "${speaker}"`, 'info');

            try {
                const formData = new FormData();
                formData.append('text', text);
                formData.append('speaker', speaker);

                log('Sending request to voice server...', 'info');
                const response = await fetch(`${VOICE_SERVER}/generate`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    log('âŒ Generation failed!', 'error');
                    log('Status: ' + response.status, 'error');
                    log('Error: ' + errorText, 'error');
                    return;
                }

                const blob = await response.blob();
                log('âœ… Audio generated successfully!', 'success');
                log(`Size: ${(blob.size / 1024).toFixed(2)} KB`, 'success');

                // Play the audio
                const audioUrl = URL.createObjectURL(blob);
                const audio = new Audio(audioUrl);
                audio.play();
                log('ðŸ”Š Playing audio...', 'success');

            } catch (error) {
                log('âŒ Generation error!', 'error');
                log('Error: ' + error.message, 'error');
            }
        }

        async function testGenerateViaAPI() {
            clearLog();
            const text = document.getElementById('testText').value || "Hello, this is a test.";
            const speaker = document.getElementById('testSpeaker').value || "John F. Kennedy";

            log(`Testing generation via Next.js API...`, 'info');
            log(`Text: "${text}"`, 'info');
            log(`Speaker: "${speaker}"`, 'info');

            try {
                log('Sending request to Next.js API...', 'info');
                const response = await fetch(`${NEXTJS_API}/api/voice/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text, speaker })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    log('âŒ API generation failed!', 'error');
                    log('Status: ' + response.status, 'error');
                    log('Error: ' + JSON.stringify(errorData, null, 2), 'error');
                    return;
                }

                const blob = await response.blob();
                log('âœ… Audio generated via API successfully!', 'success');
                log(`Size: ${(blob.size / 1024).toFixed(2)} KB`, 'success');

                // Play the audio
                const audioUrl = URL.createObjectURL(blob);
                const audio = new Audio(audioUrl);
                audio.play();
                log('ðŸ”Š Playing audio...', 'success');

            } catch (error) {
                log('âŒ API error!', 'error');
                log('Error: ' + error.message, 'error');
            }
        }

        // Auto-run server status check on load
        window.onload = () => {
            log('Voice Server Diagnostic Tool Ready', 'info');
            log('Click "Check if server is running" to start tests', 'info');
        };
    </script>
</body>
</html>
